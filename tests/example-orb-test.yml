version: 2.1

# Example standalone test pipeline for the Neon orb.
# Use this when you want to manually validate the dev orb version.
orbs:
  neon: dhanushreddy291/neon@1.0

jobs:
  test-create-delete:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout

      - neon/create_branch:
          branch_name: "ci-test-create-delete-<< pipeline.number >>"
          ttl_seconds: 600

      - run:
          name: Verify Exported Variables
          command: |
            echo "=== Verifying exported environment variables ==="

            FAIL=0
            for var in DATABASE_URL DATABASE_URL_POOLED PGHOST PGHOST_POOLED PGUSER PGPASSWORD PGDATABASE NEON_BRANCH_ID; do
              if [ -z "${!var:-}" ]; then
                echo "FAIL: $var is not set"
                FAIL=1
              else
                echo "OK:   $var is set"
              fi
            done

            if [ "$FAIL" -eq 1 ]; then
              echo ""
              echo "Some variables are missing!"
              exit 1
            fi

            echo ""
            echo "All variables verified successfully."
            echo ""
            echo "DATABASE_URL starts with: $(echo "$DATABASE_URL" | head -c 30)..."
            echo "PGHOST:     $PGHOST"
            echo "PGDATABASE: $PGDATABASE"
            echo "PGUSER:     $PGUSER"
            echo "BRANCH_ID:  $NEON_BRANCH_ID"

      - run:
          name: Test Database Connectivity
          command: |
            if command -v pg_isready >/dev/null 2>&1; then
              echo "Testing connectivity with pg_isready..."
              pg_isready -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" && echo "Connection successful!" || echo "pg_isready check failed"
            fi

      - neon/delete_branch

  test-idempotent-create:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout

      - neon/create_branch:
          branch_name: "ci-test-idempotent-<< pipeline.number >>"
          ttl_seconds: 600

      - run:
          name: Record First Branch ID
          command: |
            echo "First creation - Branch ID: $NEON_BRANCH_ID"
            echo "$NEON_BRANCH_ID" > /tmp/first_branch_id

      - neon/create_branch:
          branch_name: "ci-test-idempotent-<< pipeline.number >>"
          ttl_seconds: 600

      - run:
          name: Verify Branch Was Reused
          command: |
            FIRST_ID=$(cat /tmp/first_branch_id)
            echo "First Branch ID:  $FIRST_ID"
            echo "Second Branch ID: $NEON_BRANCH_ID"
            if [ "$FIRST_ID" = "$NEON_BRANCH_ID" ]; then
              echo "Branch was correctly reused (idempotent)."
            else
              echo "ERROR: Branch IDs don't match. Expected reuse."
              exit 1
            fi

      - neon/delete_branch

workflows:
  test-everything:
    jobs:
      - test-create-delete

      - test-idempotent-create

      - neon/run_tests:
          migrate_command: 'echo ''Running migrations against Neon branch...'' && echo "DATABASE_URL is set: $(echo $DATABASE_URL | head -c 30)..."'
          test_command: 'echo ''Running tests against Neon branch...'' && echo "PGHOST: $PGHOST" && echo ''All tests passed!'''
          ttl_seconds: 600
          requires:
            - test-create-delete
