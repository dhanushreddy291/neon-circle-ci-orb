version: 2.1
orbs:
  orb-tools: circleci/orb-tools@12.3
  neon: {}

# Use this tag to ensure test jobs always run,
# even though the downstream publish job will only run on release tags.
filters: &filters
  tags:
    only: /.*/

# Filter for release tags.
release-filters: &release-filters
  branches:
    ignore: /.*/
  tags:
    only: /^v[0-9]+\.[0-9]+\.[0-9]+$/

jobs:
  smoke-test:
    docker:
      - image: cimg/base:current
    steps:
      - checkout
      - run:
          name: Validate source tree contains Neon commands
          command: |
            test -f src/commands/create-branch.yml
            test -f src/commands/delete-branch.yml
            test -f src/commands/reset-branch.yml

  test-create-delete:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout

      - neon/create-branch:
          branch_name: "ci-test-create-delete-<< pipeline.number >>"
          ttl_seconds: 600

      - run:
          name: Verify Exported Variables
          command: |
            echo "=== Verifying exported environment variables ==="

            FAIL=0
            for var in DATABASE_URL DATABASE_URL_POOLED PGHOST PGHOST_POOLED PGUSER PGPASSWORD PGDATABASE NEON_BRANCH_ID; do
              if [ -z "${!var:-}" ]; then
                echo "FAIL: $var is not set"
                FAIL=1
              else
                echo "OK:   $var is set"
              fi
            done

            if [ "$FAIL" -eq 1 ]; then
              echo ""
              echo "Some variables are missing!"
              exit 1
            fi

            echo ""
            echo "All variables verified successfully."
            echo ""
            echo "DATABASE_URL starts with: $(echo "$DATABASE_URL" | head -c 30)..."
            echo "PGHOST:     $PGHOST"
            echo "PGDATABASE: $PGDATABASE"
            echo "PGUSER:     $PGUSER"
            echo "BRANCH_ID:  $NEON_BRANCH_ID"

      - run:
          name: Test Database Connectivity
          command: |
            if command -v pg_isready >/dev/null 2>&1; then
              echo "Testing connectivity with pg_isready..."
              pg_isready -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE" && echo "Connection successful!" || echo "pg_isready check failed"
            fi

      - neon/delete-branch

  test-idempotent-create:
    docker:
      - image: cimg/base:stable
    resource_class: small
    steps:
      - checkout

      - neon/create-branch:
          branch_name: "ci-test-idempotent-<< pipeline.number >>"
          ttl_seconds: 600

      - run:
          name: Record First Branch ID
          command: |
            echo "First creation - Branch ID: $NEON_BRANCH_ID"
            echo "$NEON_BRANCH_ID" > /tmp/first_branch_id

      - neon/create-branch:
          branch_name: "ci-test-idempotent-<< pipeline.number >>"
          ttl_seconds: 600

      - run:
          name: Verify Branch Was Reused
          command: |
            FIRST_ID=$(cat /tmp/first_branch_id)
            echo "First Branch ID:  $FIRST_ID"
            echo "Second Branch ID: $NEON_BRANCH_ID"
            if [ "$FIRST_ID" = "$NEON_BRANCH_ID" ]; then
              echo "Branch was correctly reused (idempotent)."
            else
              echo "ERROR: Branch IDs don't match. Expected reuse."
              exit 1
            fi

      - neon/delete-branch
workflows:
  test-deploy:
    jobs:
      - smoke-test:
          filters: *filters

      - test-create-delete:
          filters: *filters
          requires:
            - smoke-test

      - test-idempotent-create:
          filters: *filters
          requires:
            - smoke-test

      - neon/run_tests:
          migrate_command: 'echo ''Running migrations against Neon branch...'' && echo "DATABASE_URL is set: $(echo $DATABASE_URL | head -c 30)..."'
          test_command: 'echo ''Running tests against Neon branch...'' && echo "PGHOST: $PGHOST" && echo ''All tests passed!'''
          ttl_seconds: 600
          requires:
            - test-create-delete
          filters: *filters

      # The orb must be re-packed for publishing, and saved to the workspace.
      - orb-tools/pack:
          filters: *release-filters
      - orb-tools/publish:
          orb_name: dhanushreddy291/neon
          vcs_type: << pipeline.project.type >>
          pub_type: production
          # Ensure this job requires all test jobs and the pack job.
          requires:
            - orb-tools/pack
            - smoke-test
          context: orb-publishing
          filters: *release-filters
